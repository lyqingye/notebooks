### 前言

这个和`getPropertyValue` 有很多相似的地方 

+ 解析嵌套属性得到 `Accessor` 
+ 生成 `token` 实际上也就是支持 `集合类型`
+ 然后调用 `AbstractNestablePropertyAccessor#setProperty`

`setPropertyValue`

```java
public void setPropertyValue(String propertyName, @Nullable Object value) throws BeansException {
		// [1] 获取嵌套属性中的最后一个Accessor
		AbstractNestablePropertyAccessor nestedPa;
		try {
			nestedPa = getPropertyAccessorForPropertyPath(propertyName);
		}
		catch (NotReadablePropertyException ex) {
			throw new NotWritablePropertyException(getRootClass(), this.nestedPath + propertyName,
					"Nested property in path '" + propertyName + "' does not exist", ex);
		}
		// [2] 生成Token
		PropertyTokenHolder tokens = getPropertyNameTokens(getFinalPath(nestedPa, propertyName));

		// [3] 根据Token设置值
		nestedPa.setPropertyValue(tokens, new PropertyValue(propertyName, value));
	}
```

是不是缺少了 `PropertyHandler` ？，不用疑问，因为`setProperty`支持 通用类型转换，强得一匹, 所以类型转换后才需要到 `PropertyHandler`

继续跟

```java
protected void setPropertyValue(PropertyTokenHolder tokens, PropertyValue pv) throws BeansException {
		if (tokens.keys != null) {
			// [1] 处理带key 的值, 类型可以是 map,list,array
			processKeyedProperty(tokens, pv);
		}
		else {
			// [2] 处理不带key的值,也就是普通类型，或者pojo
			processLocalProperty(tokens, pv);
		}
	}
```

**处理带key** 

```java
xprivate void processKeyedProperty(PropertyTokenHolder tokens, PropertyValue pv) {
   // [1] 这里获取属性值，这里是setProperty为什么要获取值？
   // 用于判断值的类型
   Object propValue = getPropertyHoldingValue(tokens);x
```

先看第一步，调用了 `getPropertyHoldingValue` 来拿到值，为什么直接用 `Handler#getPropertyValue`?

```java
private Object getPropertyHoldingValue(PropertyTokenHolder tokens) {

		// Apply indexes and map keys: fetch value for all keys but the last one.
		Assert.state(tokens.keys != null, "No token keys");
		PropertyTokenHolder getterTokens = new PropertyTokenHolder(tokens.actualName);
		getterTokens.canonicalName = tokens.canonicalName;
		getterTokens.keys = new String[tokens.keys.length - 1];
		System.arraycopy(tokens.keys, 0, getterTokens.keys, 0, tokens.keys.length - 1);

		Object propValue;
		try {
			// 还是调用了 getPropertyValue
			propValue = getPropertyValue(getterTokens);
		}
		}

		// [TODO] 这个暂时不知道为何
		if (propValue == null) {
			// null map value case
			if (isAutoGrowNestedPaths()) {
				int lastKeyIndex = tokens.canonicalName.lastIndexOf('[');
				getterTokens.canonicalName = tokens.canonicalName.substring(0, lastKeyIndex);
				propValue = setDefaultValue(getterTokens);
			}
		}
		return propValue;
	}
```
